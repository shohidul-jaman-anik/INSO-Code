services:
  inso_code_app:
    build:
      context: .
      dockerfile: Dockerfile.app
    container_name: inso_code_app
    env_file:
      - .env
    ports:
      - '5100:5100'
    volumes:
      - .:/app/inso-code-service:cached
      - node_modules:/app/inso-code-service/node_modules
    networks:
      - inso_code_network
    restart: unless-stopped

  elasticsearch:
    image: elasticsearch:8.18.1
    container_name: elasticsearch
    restart: always
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
      - ES_JAVA_OPTS=-Xms1024m -Xmx1024m
    ports:
      - '9200:9200'
      - '9300:9300'
    networks:
      - inso_code_network

  kibana:
    image: kibana:8.18.1
    container_name: kibana
    restart: always
    environment:
      ELASTICSEARCH_HOSTS: 'http://elasticsearch:9200'
    ports:
      - '5601:5601'
    depends_on:
      - elasticsearch
    networks:
      - inso_code_network

  inso_code_editor:
    build:
      context: .
      dockerfile: Dockerfile.code-server
    image: codercom/code-server:latest
    container_name: inso_code_editor
    environment:
      - PASSWORD=${CODE_SERVER_PASSWORD:-mySecret123}
      - TZ=Asia/Dhaka
    ports:
      - '8080:8080'
    command: [
        '--bind-addr',
        '0.0.0.0:8080',
        '--auth',
        'password',
        # OPEN BLANK â€” NO PROJECT
        '.',
      ]
    user: root
    # REMOVE project mount to stop auto-loading!
    volumes:
      #  - "C:/:/user-projects"
      - /user-projects:/user-projects
      - code_server_data:/home/coder/.local/share/code-server
      - ./vscode-settings.json:/home/coder/.local/share/code-server/User/settings.json

    networks:
      - inso_code_network
    restart: unless-stopped

networks:
  inso_code_network:
    driver: bridge

volumes:
  node_modules:
  code_server_data:
